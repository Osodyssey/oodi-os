<!doctype html>
<html>
  <head><meta charset="utf-8"><title>Oodi demo (secure)</title></head>
  <body>
    <h3>Login</h3>
    <input id="user" placeholder="username" value="alice">
    <input id="pw" placeholder="password" value="password" type="password">
    <button id="login">Login</button>
    <p id="status"></p>

    <h3>Actions</h3>
    <button id="pay">Pay 100</button>

    <script type="module">
      import { setAuthToken } from '../src/runtime/oodi-runtime.js';
      import { pay } from '../out.js';

      document.getElementById('login').addEventListener('click', async ()=>{
        const u = document.getElementById('user').value;
        const p = document.getElementById('pw').value;
        const res = await fetch('/api/login', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username: u, password: p })});
        if (!res.ok) {
          document.getElementById('status').innerText = 'login failed';
          return;
        }
        const { token } = await res.json();
        setAuthToken(token);
        document.getElementById('status').innerText = 'logged in as '+u;
      });

      document.getElementById('pay').addEventListener('click', async ()=> {
        try {
          const r = await pay(100);
          console.log('response', r);
          alert('done: ' + JSON.stringify(r));
        } catch(e) {
          console.error(e);
          alert('error: ' + e.message);
        }
      });
    </script>
  </body>
</html>
