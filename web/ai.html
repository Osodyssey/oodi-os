<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Oodi AI Demo</title>
  </head>
  <body>
    <h2 id="modeTitle">Oodi AI Demo</h2>

    <div id="loginBox">
      <h3>Login</h3>
      <input id="user" placeholder="username" value="alice" />
      <input id="pw" placeholder="password" value="password" type="password" />
      <button id="loginBtn">Login</button>
      <p id="status"></p>
    </div>

    <div id="askBox" style="display: none">
      <h3>Ask AI</h3>
      <input id="prompt" placeholder="Prompt برای AI" style="width: 60%" />
      <button id="askBtn">Ask</button>
      <pre id="output"></pre>
    </div>

    <script type="module">
      import { setAuthToken } from "../src/runtime/oodi-runtime.js";
      import { askAI } from "../out-ai.js";

      // detect server demo mode
      async function getStatus() {
        try {
          const res = await fetch("/api/status");
          if (!res.ok) return { demo: false };
          return await res.json();
        } catch (e) {
          return { demo: false };
        }
      }

      (async () => {
        const status = await getStatus();
        if (status.demo) {
          document.getElementById("modeTitle").innerText += " — DEMO MODE";
          // hide login and show ask box (demo mode allows proxy without login)
          document.getElementById("loginBox").style.display = "none";
          document.getElementById("askBox").style.display = "block";
        } else {
          document.getElementById("loginBox").style.display = "block";
          document.getElementById("askBox").style.display = "none";
        }
      })();

      document.getElementById("loginBtn").onclick = async () => {
        const user = document.getElementById("user").value;
        const pw = document.getElementById("pw").value;
        const res = await fetch("/api/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username: user, password: pw }),
        });
        if (!res.ok) {
          document.getElementById("status").innerText = "Login failed";
          return;
        }
        const { token } = await res.json();
        setAuthToken(token);
        document.getElementById("status").innerText = "Logged in as " + user;
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("askBox").style.display = "block";
      };

      document.getElementById("askBtn").onclick = async () => {
        const prompt = document.getElementById("prompt").value;
        try {
          const r = await askAI(prompt);
          document.getElementById("output").innerText = JSON.stringify(
            r,
            null,
            2
          );
        } catch (e) {
          document.getElementById("output").innerText = e.message;
        }
      };
    </script>
  </body>
</html>
